@*  
- @page "/login"
- Autor: Victor Oliveros
- Fecha: 10/2025
- Version: 1.0
- Descripción: Página de login completa para autenticación de usuarios.
- Notas: Sistema de autenticación funcional con validación y navegación

Documentación: Página de autenticación completa que valida usuario y contraseña contra la API.
*@

@page "/"
@layout FrontendBlazorApi.Components.Layout.EmptyLayout

@using FrontendBlazorApi.Models
@using FrontendBlazorApi.Servicios
@using System.ComponentModel.DataAnnotations
@using BCrypt.Net

@inject ServicioAutenticacion servicioAuth
@inject ServicioApiGenerico servicioApi
@inject NavigationManager navegacion
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Iniciar Sesión - Sistema de Proyectos</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center"
    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="row w-100">
        <div class="col-md-6 col-lg-4 mx-auto">
            <!-- Tarjeta principal de login -->
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header text-white text-center py-4 rounded-top-4"
                    style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                    <div class="mb-3">
                        <i class="bi bi-shield-lock display-3"></i>
                    </div>
                    <h3 class="mb-1 fw-bold">Sistema de Proyectos</h3>
                    <p class="mb-0 opacity-90">Ingrese sus credenciales para acceder</p>
                </div>

                <div class="card-body p-4">
                    @if (!string.IsNullOrWhiteSpace(mensaje))
                    {
                        <div class="@claseAlerta alert-dismissible fade show" role="alert">
                            <i class="bi @iconoAlerta me-2"></i>
                            @mensaje
                            <button type="button" class="btn-close" @onclick="LimpiarMensajes" aria-label="Close"></button>
                        </div>
                    }

                    <EditForm Model="@modeloLogin" OnValidSubmit="ProcesarLogin" FormName="LoginForm">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-envelope me-2 text-primary"></i>
                                Correo Electrónico
                            </label>
                            <InputText class="form-control form-control-lg shadow-sm" @bind-Value="modeloLogin.Email"
                                placeholder="ejemplo@correo.com" disabled="@cargando" autocomplete="email" />
                            <ValidationMessage For="@(() => modeloLogin.Email)" class="text-danger small mt-1" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-lock me-2 text-primary"></i>
                                Contraseña
                            </label>
                            <div class="input-group">
                                <InputText type="@tipoPassword" class="form-control form-control-lg shadow-sm"
                                    @bind-Value="modeloLogin.Contrasena" placeholder="Ingrese su contraseña"
                                    disabled="@cargando" autocomplete="current-password" />
                                <button class="btn btn-outline-secondary" type="button"
                                    @onclick="TogglePasswordVisibility" disabled="@cargando">
                                    <i class="bi @iconoPassword"></i>
                                </button>
                            </div>
                            <ValidationMessage For="@(() => modeloLogin.Contrasena)" class="text-danger small mt-1" />
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary btn-lg shadow-sm fw-semibold"
                                disabled="@cargando">
                                @if (cargando)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"
                                        aria-hidden="true"></span>
                                    <span>Verificando credenciales...</span>
                                }
                                else
                                {
                                    <i class="bi bi-box-arrow-in-right me-2"></i>
                                    <span>Iniciar Sesión</span>
                                }
                            </button>
                        </div>

                        <ValidationSummary class="text-danger small" />
                    </EditForm>
                </div>

                <div class="card-footer bg-light text-center py-3 rounded-bottom-4">
                    <small class="text-muted">
                        <i class="bi bi-shield-check me-1 text-success"></i>
                        Sistema Seguro v1.0 © 2025
                        <br />
                        <i class="bi bi-code-slash me-1"></i>
                        Desarrollado por Victor Oliveros
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // ==========================================
    // MODELO PARA EL FORMULARIO DE LOGIN
    // ==========================================
    public class ModeloLogin
    {
        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "Formato de email inválido")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "La contraseña es requerida")]
        [MinLength(3, ErrorMessage = "La contraseña debe tener al menos 3 caracteres")]
        public string Contrasena { get; set; } = string.Empty;
    }

    // ==========================================
    // VARIABLES DE ESTADO
    // ==========================================
    [SupplyParameterFromForm]
    private ModeloLogin modeloLogin { get; set; } = new();

    private bool cargando = false;
    private bool mostrarPassword = false;
    private string mensaje = "";
    private string claseAlerta = "";
    private string iconoAlerta = "";

    // Propiedades computadas para la UI
    private string tipoPassword => mostrarPassword ? "text" : "password";
    private string iconoPassword => mostrarPassword ? "bi-eye-slash" : "bi-eye";

    // ==========================================
    // CICLO DE VIDA DEL COMPONENTE
    // ==========================================
    protected override void OnInitialized()
    {
        VerificarParametrosURL();
    }

    // ==========================================
    // MÉTODOS DE AUTENTICACIÓN
    // ==========================================
    private async Task ProcesarLogin()
    {
        LimpiarMensajes();
        cargando = true;

        try
        {
            // Buscar usuario usando el servicio genérico
            var usuario = await BuscarUsuarioPorEmail(modeloLogin.Email);

            if (usuario != null)
            {
                if (!usuario.Activo)
                {
                    MostrarMensaje("Usuario inactivo. Contacte al administrador.", "warning", "bi-person-x");
                    return;
                }

                // Validar contraseña real del usuario
                if (ValidarContrasenaReal(modeloLogin.Contrasena, usuario.Contrasena))
                {
                    // Determinar si es administrador por tipo de usuario
                    bool esAdmin = usuario.TipoUsuario.Equals("Administrador", StringComparison.OrdinalIgnoreCase);

                    // Usar el servicio de autenticación para iniciar sesión
                    await IniciarSesionExitosa(usuario.Email, usuario.Id ?? 0, esAdmin, usuario.TipoUsuario);
                }
                else
                {
                    MostrarMensaje("Contraseña incorrecta. Verifique sus credenciales.", "danger", "bi-key");
                }
            }
            else
            {
                MostrarMensaje("Usuario no encontrado. Verifique el email ingresado.", "warning", "bi-person-exclamation");
            }
        }
        catch (Exception error)
        {
            MostrarMensaje($"Error de conexión: {error.Message}", "danger", "bi-wifi-off");
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task<Usuario?> BuscarUsuarioPorEmail(string email)
    {
        try
        {
            // Usar ServicioApiGenerico para obtener usuarios
            var respuesta = await servicioApi.ObtenerTodosAsync<Usuario>("usuario");
            var usuarios = respuesta ?? new List<Usuario>();

            return usuarios.FirstOrDefault(u =>
            u.Email.Equals(email, StringComparison.OrdinalIgnoreCase));
        }
        catch
        {
            return null;
        }
    }

    private bool ValidarContrasenaReal(string contrasenaIngresada, string hashAlmacenado)
    {
        try
        {
            // Validar usando BCrypt para verificar el hash
            // BCrypt.Verify compara la contraseña en texto plano con el hash almacenado
            return BCrypt.Verify(contrasenaIngresada, hashAlmacenado);
        }
        catch (Exception)
        {
            // Si el hash no es válido o hay algún error, retornar false
            return false;
        }
    }

    private async Task IniciarSesionExitosa(string nombreUsuario, int usuarioId, bool esAdmin, string tipoUsuario = "User")
    {
        // Guardar información de sesión en sessionStorage
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "email", nombreUsuario);
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "usuario_id", usuarioId.ToString());
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "es_admin", esAdmin.ToString());
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "tipo_usuario", tipoUsuario);

        MostrarMensaje($"¡Bienvenido {nombreUsuario}! Redirigiendo al sistema...", "success", "bi-check-circle");

        await Task.Delay(1500);
        navegacion.NavigateTo("/dashboard", true);
    }

    // ==========================================
    // MÉTODOS AUXILIARES Y UI
    // ==========================================
    private void TogglePasswordVisibility()
    {
        mostrarPassword = !mostrarPassword;
    }

    private void VerificarParametrosURL()
    {
        var uri = new Uri(navegacion.Uri);
        if (uri.Query.Contains("expired"))
        {
            MostrarMensaje("Su sesión ha expirado. Por favor inicie sesión nuevamente.", "warning", "bi-clock");
        }
        else if (uri.Query.Contains("unauthorized"))
        {
            MostrarMensaje("Acceso no autorizado. Debe iniciar sesión para continuar.", "info", "bi-shield-exclamation");
        }
    }

    private void MostrarMensaje(string texto, string tipo, string icono = "")
    {
        mensaje = texto;
        iconoAlerta = string.IsNullOrEmpty(icono) ? "bi-info-circle" : icono;
        claseAlerta = $"alert alert-{tipo}";
    }

    private void LimpiarMensajes()
    {
        mensaje = "";
        claseAlerta = "";
        iconoAlerta = "";
    }
}