@*  
- @page "/producto-entregables"
- Autor: Victor Oliveros
- Fecha: 01/2025
- Version: 3.0
- Descripción: Vista CRUD con selección múltiple para asociaciones Producto-Entregable
- Notas: Modal para asociar/eliminar múltiples productos a un entregable
- Modelo de Datos:
  * Producto_Entregable (tabla intermedia con clave compuesta)
  * Permite asociar/eliminar múltiples productos a la vez
  * Interfaz con modales para mejor UX

Documentación: Vista para gestionar asociaciones múltiples Producto-Entregable.
Sigue el modelo de base de datos definido en docs/ModelosBD.txt
*@

@page "/producto-entregables"

@using System.Net.Http.Json
@using FrontendBlazorApi.Models
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq

@inject IHttpClientFactory fabricaHttp
@rendermode InteractiveServer

<PageTitle>Producto-Entregables</PageTitle>

<div class="container items-center">
  <div class="welcome-card">
    <h5 class="display-4 text-primary mb-4">
      <i class="bi bi-diagram-3-fill me-2"></i>
      Gestión de Relaciones Producto-Entregable
    </h5>

    @* Barra de acciones principales *@
    <div class="mb-3 d-flex gap-2 items-center">
      <button type="button" class="btn btn-outline-primary" @onclick="CargarAsociaciones">
        <i class="bi bi-eye" aria-hidden="true"></i> Mostrar todas
      </button>
      <button type="button" class="btn btn-outline-success" @onclick="CargarDatosIniciales">
        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i> Cargar Datos
      </button>
      <button type="button" class="btn btn-success" @onclick="AbrirModalAgregar">
        <i class="bi bi-plus-circle" aria-hidden="true"></i> Asociar Productos
      </button>
      <button type="button" class="btn btn-danger" @onclick="AbrirModalEliminar">
        <i class="bi bi-trash" aria-hidden="true"></i> Eliminar Asociaciones
      </button>
    </div>

    @* Mensajes generales *@
    @if (!string.IsNullOrWhiteSpace(mensajeGeneral))
    {
      <div class="@claseAvisoGeneral" role="alert">@mensajeGeneral</div>
    }

    <hr />

    @* Tabla de asociaciones existentes *@
    @if (cargando)
    {
      <p><em>Cargando asociaciones...</em></p>
    }
    else if (listaAsociaciones.Count == 0)
    {
      <p>No hay asociaciones Producto-Entregable registradas.</p>
    }
    else
    {
      <h4>Listado de Asociaciones</h4>
      <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
          <tr>
            <th>ID Producto</th>
            <th>Código Producto</th>
            <th>Título Producto</th>
            <th>ID Entregable</th>
            <th>Código Entregable</th>
            <th>Título Entregable</th>
            <th>Fecha Asociación</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var asociacion in listaAsociaciones)
          {
            var producto = listaProductos.FirstOrDefault(p => p.Id == asociacion.IdProducto);
            var entregable = listaEntregables.FirstOrDefault(e => e.Id == asociacion.IdEntregable);

            <tr>
              <td>@asociacion.IdProducto</td>
              <td>@(producto?.Codigo ?? "N/A")</td>
              <td>@(producto?.Titulo ?? "Sin información")</td>
              <td>@asociacion.IdEntregable</td>
              <td>@(entregable?.Codigo ?? "N/A")</td>
              <td>@(entregable?.Titulo ?? "Sin información")</td>
              <td>@(asociacion.FechaAsociacion?.ToString("dd/MM/yyyy") ?? "Sin fecha")</td>
            </tr>
          }
        </tbody>
      </table>

      @* Resumen estadístico *@
      <div class="mt-4">
        <h5>Resumen por Entregable</h5>
        <table class="table table-sm table-bordered">
          <thead class="table-info">
            <tr>
              <th>Código Entregable</th>
              <th>Título Entregable</th>
              <th>Cantidad de Productos</th>
              <th>Última Fecha Asociación</th>
            </tr>
          </thead>
          <tbody>
            @foreach (var grupo in listaAsociaciones.GroupBy(a => a.IdEntregable))
            {
              var entregable = listaEntregables.FirstOrDefault(e => e.Id == grupo.Key);
              var cantidadProductos = grupo.Count();
              var ultimaFecha = grupo.Max(a => a.FechaAsociacion);

              <tr>
                <td>@(entregable?.Codigo ?? "N/A")</td>
                <td>@(entregable?.Titulo ?? "Sin información")</td>
                <td>
                  <span class="badge bg-primary">@cantidadProductos</span>
                </td>
                <td>@(ultimaFecha?.ToString("dd/MM/yyyy") ?? "Sin fecha")</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

@* ========================================== *@
@* MODAL PARA AGREGAR ASOCIACIONES MÚLTIPLES *@
@* ========================================== *@
@if (mostrarModalAgregar)
{
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="bi bi-plus-circle-fill me-2"></i>
            Asociar Productos a Entregable
          </h5>
          <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalAgregar"></button>
        </div>
        <div class="modal-body">
          @* Mensajes dentro del modal *@
          @if (!string.IsNullOrWhiteSpace(mensajeModal))
          {
            <div class="@claseAvisoModal alert-dismissible fade show" role="alert">
              @mensajeModal
              <button type="button" class="btn-close" @onclick="LimpiarMensajesModal"></button>
            </div>
          }

          <EditForm Model="modeloAgregar" OnValidSubmit="AgregarAsociacionesMultiples" FormName="AgregarForm">
            <div class="mb-3">
              <label for="entregableSelectAgregar" class="form-label">
                <strong>1. Seleccione el Entregable</strong> <span class="text-danger">*</span>
              </label>
              <InputSelect id="entregableSelectAgregar" class="form-select form-select-lg"
                @bind-Value="modeloAgregar.IdEntregable" @onchange="CargarProductosDisponibles">
                <option value="0">-- Seleccione un entregable --</option>
                @foreach (var entregable in listaEntregables)
                {
                  <option value="@entregable.Id">
                    [@entregable.Codigo] @entregable.Titulo
                  </option>
                }
              </InputSelect>
            </div>

            @if (modeloAgregar.IdEntregable > 0)
            {
              <div class="mb-3">
                <label class="form-label">
                  <strong>2. Seleccione los Productos a Asociar</strong> <span class="text-danger">*</span>
                </label>
                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                  @if (productosDisponibles.Count == 0)
                  {
                    <p class="text-muted">Todos los productos ya están asociados a este entregable.</p>
                  }
                  else
                  {
                    @foreach (var producto in productosDisponibles)
                    {
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="prod_@producto.Id"
                          @onchange="@(e => ToggleProductoSeleccionado(producto.Id, e.Value))" />
                        <label class="form-check-label" for="prod_@producto.Id">
                          <strong>[@producto.Codigo]</strong> @producto.Titulo
                        </label>
                      </div>
                    }
                  }
                </div>
                @if (modeloAgregar.IdsProductos.Count > 0)
                {
                  <small class="text-success">
                    <i class="bi bi-check-circle"></i> @modeloAgregar.IdsProductos.Count producto(s) seleccionado(s)
                  </small>
                }
              </div>

              <div class="mb-3">
                <label for="fechaAsociacionAgregar" class="form-label">
                  <strong>3. Fecha de Asociación</strong>
                </label>
                <InputDate id="fechaAsociacionAgregar" class="form-control" @bind-Value="modeloAgregar.FechaAsociacion" />
              </div>
            }

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" @onclick="CerrarModalAgregar">
                <i class="bi bi-x-circle"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-success"
                disabled="@(modeloAgregar.IdEntregable <= 0 || modeloAgregar.IdsProductos.Count == 0 || procesando)">
                <i class="bi bi-save"></i>
                @if (procesando)
                {
                  <span>Procesando...</span>
                }
                else
                {
                  <span>Asociar @modeloAgregar.IdsProductos.Count Producto(s)</span>
                }
              </button>
            </div>
          </EditForm>
        </div>
      </div>
    </div>
  </div>
}

@* ========================================== *@
@* MODAL PARA ELIMINAR ASOCIACIONES MÚLTIPLES *@
@* ========================================== *@
@if (mostrarModalEliminar)
{
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="bi bi-trash-fill me-2"></i>
            Eliminar Asociaciones de Productos
          </h5>
          <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalEliminar"></button>
        </div>
        <div class="modal-body">
          @* Mensajes dentro del modal *@
          @if (!string.IsNullOrWhiteSpace(mensajeModal))
          {
            <div class="@claseAvisoModal alert-dismissible fade show" role="alert">
              @mensajeModal
              <button type="button" class="btn-close" @onclick="LimpiarMensajesModal"></button>
            </div>
          }

          <EditForm Model="modeloEliminar" OnValidSubmit="EliminarAsociacionesMultiples" FormName="EliminarForm">
            <div class="mb-3">
              <label for="entregableSelectEliminar" class="form-label">
                <strong>1. Seleccione el Entregable</strong> <span class="text-danger">*</span>
              </label>
              <InputSelect id="entregableSelectEliminar" class="form-select form-select-lg"
                @bind-Value="modeloEliminar.IdEntregable" @onchange="CargarProductosAsociados">
                <option value="0">-- Seleccione un entregable --</option>
                @foreach (var entregable in listaEntregables)
                {
                  <option value="@entregable.Id">
                    [@entregable.Codigo] @entregable.Titulo
                  </option>
                }
              </InputSelect>
            </div>

            @if (modeloEliminar.IdEntregable > 0)
            {
              <div class="mb-3">
                <label class="form-label">
                  <strong>2. Seleccione los Productos a Desasociar</strong> <span class="text-danger">*</span>
                </label>
                <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                  @if (productosAsociados.Count == 0)
                  {
                    <p class="text-muted">Este entregable no tiene productos asociados.</p>
                  }
                  else
                  {
                    @foreach (var asociacion in productosAsociados)
                    {
                      var producto = listaProductos.FirstOrDefault(p => p.Id == asociacion.IdProducto);
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="elim_@asociacion.IdProducto"
                          @onchange="@(e => ToggleProductoEliminar(asociacion.IdProducto, e.Value))" />
                        <label class="form-check-label" for="elim_@asociacion.IdProducto">
                          <strong>[@(producto?.Codigo)]</strong> @(producto?.Titulo)
                          <small class="text-muted">
                            - Fecha: @(asociacion.FechaAsociacion?.ToString("dd/MM/yyyy") ?? "N/A")
                          </small>
                        </label>
                      </div>
                    }
                  }
                </div>
                @if (modeloEliminar.IdsProductos.Count > 0)
                {
                  <small class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i> @modeloEliminar.IdsProductos.Count producto(s)
                    seleccionado(s) para eliminar
                  </small>
                }
              </div>
            }

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" @onclick="CerrarModalEliminar">
                <i class="bi bi-x-circle"></i> Cancelar
              </button>
              <button type="submit" class="btn btn-danger"
                disabled="@(modeloEliminar.IdEntregable <= 0 || modeloEliminar.IdsProductos.Count == 0 || procesando)">
                <i class="bi bi-trash"></i>
                @if (procesando)
                {
                  <span>Procesando...</span>
                }
                else
                {
                  <span>Eliminar @modeloEliminar.IdsProductos.Count Asociación(es)</span>
                }
              </button>
            </div>
          </EditForm>
        </div>
      </div>
    </div>
  </div>
}

@code {
  // ==========================================
  // VARIABLES DE ESTADO
  // ==========================================

  // Listas principales
  private List<Producto_Entregable> listaAsociaciones = new();
  private List<Producto> listaProductos = new();
  private List<Entregable> listaEntregables = new();

  // Listas para modales
  private List<Producto> productosDisponibles = new();
  private List<Producto_Entregable> productosAsociados = new();

  // Modelos para formularios
  private ModeloAgregarAsociaciones modeloAgregar = new();
  private ModeloEliminarAsociaciones modeloEliminar = new();

  // Control de modales
  private bool mostrarModalAgregar = false;
  private bool mostrarModalEliminar = false;
  private bool procesando = false;

  // Mensajes
  private string mensajeGeneral = "";
  private string claseAvisoGeneral = "alert alert-info";
  private string mensajeModal = "";
  private string claseAvisoModal = "alert alert-info";

  private bool cargando = false;

  // URLs de la API
  private const string urlBaseApiAsociaciones = "api/producto_entregable";
  private const string urlBaseApiProductos = "api/producto";
  private const string urlBaseApiEntregables = "api/entregable";

  // ==========================================
  // CLASES AUXILIARES PARA FORMULARIOS
  // ==========================================

  private class ModeloAgregarAsociaciones
  {
    public int IdEntregable { get; set; }
    public List<int> IdsProductos { get; set; } = new();
    public DateTime? FechaAsociacion { get; set; } = DateTime.Now;
  }

  private class ModeloEliminarAsociaciones
  {
    public int IdEntregable { get; set; }
    public List<int> IdsProductos { get; set; } = new();
  }

  // ==========================================
  // CICLO DE VIDA
  // ==========================================

  protected override async Task OnInitializedAsync()
  {
    await CargarDatosIniciales();
    await CargarAsociaciones();
    LimpiarMensajesGeneral();
  }

  // ==========================================
  // MÉTODOS DE CARGA DE DATOS
  // ==========================================

  private async Task CargarDatosIniciales()
  {
    try
    {
      using var http = fabricaHttp.CreateClient("ApiProyecto");

      var respuestaProductos = await http.GetFromJsonAsync<RespuestaApi<List<Producto>>>(urlBaseApiProductos);
      listaProductos = respuestaProductos?.Datos ?? new List<Producto>();

      var respuestaEntregables = await http.GetFromJsonAsync<RespuestaApi<List<Entregable>>>(urlBaseApiEntregables);
      listaEntregables = respuestaEntregables?.Datos ?? new List<Entregable>();

      mensajeGeneral = $"Se cargaron {listaProductos.Count} productos y {listaEntregables.Count} entregables.";
      claseAvisoGeneral = "alert alert-info";
    }
    catch (Exception error)
    {
      mensajeGeneral = $"Error al cargar datos iniciales: {error.Message}";
      claseAvisoGeneral = "alert alert-danger";
    }
  }

  private async Task CargarAsociaciones()
  {
    try
    {
      cargando = true;
      using var http = fabricaHttp.CreateClient("ApiProyecto");

      var httpRespuesta = await http.GetAsync(urlBaseApiAsociaciones);

      // Si la respuesta es 204 (No Content), significa que no hay datos
      if (httpRespuesta.StatusCode == System.Net.HttpStatusCode.NoContent)
      {
        listaAsociaciones = new List<Producto_Entregable>();
        mensajeGeneral = "No hay asociaciones registradas en la base de datos.";
        claseAvisoGeneral = "alert alert-info";
        return;
      }

      if (httpRespuesta.IsSuccessStatusCode)
      {
        var respuesta = await httpRespuesta.Content.ReadFromJsonAsync<RespuestaApi<List<Producto_Entregable>>>();
        listaAsociaciones = respuesta?.Datos ?? new List<Producto_Entregable>();
        mensajeGeneral = $"Se cargaron {listaAsociaciones.Count} asociaciones.";
        claseAvisoGeneral = "alert alert-success";
      }
      else
      {
        mensajeGeneral = $"Error al cargar asociaciones: {httpRespuesta.StatusCode}";
        claseAvisoGeneral = "alert alert-warning";
        listaAsociaciones = new List<Producto_Entregable>();
      }
    }
    catch (Exception error)
    {
      mensajeGeneral = $"Error al cargar asociaciones: {error.Message}";
      claseAvisoGeneral = "alert alert-danger";
      listaAsociaciones = new List<Producto_Entregable>();
    }
    finally
    {
      cargando = false;
    }
  }

  // ==========================================
  // MODAL AGREGAR - MÉTODOS
  // ==========================================

  private void AbrirModalAgregar()
  {
    modeloAgregar = new ModeloAgregarAsociaciones();
    productosDisponibles.Clear();
    mostrarModalAgregar = true;
    LimpiarMensajesModal();
  }

  private void CerrarModalAgregar()
  {
    mostrarModalAgregar = false;
    modeloAgregar = new ModeloAgregarAsociaciones();
    productosDisponibles.Clear();
    LimpiarMensajesModal();
  }

  private async Task CargarProductosDisponibles(ChangeEventArgs e)
  {
    LimpiarMensajesModal();

    if (modeloAgregar.IdEntregable <= 0) return;

    try
    {
      // Obtener productos ya asociados al entregable
      var asociacionesExistentes = listaAsociaciones
      .Where(a => a.IdEntregable == modeloAgregar.IdEntregable)
      .Select(a => a.IdProducto)
      .ToList();

      // Filtrar productos disponibles (no asociados)
      productosDisponibles = listaProductos
      .Where(p => !asociacionesExistentes.Contains(p.Id))
      .ToList();

      if (productosDisponibles.Count == 0)
      {
        mensajeModal = "Todos los productos ya están asociados a este entregable.";
        claseAvisoModal = "alert alert-warning";
      }
      else
      {
        mensajeModal = $"Hay {productosDisponibles.Count} producto(s) disponible(s) para asociar.";
        claseAvisoModal = "alert alert-info";
      }
    }
    catch (Exception error)
    {
      mensajeModal = $"Error al cargar productos disponibles: {error.Message}";
      claseAvisoModal = "alert alert-danger";
    }

    await Task.CompletedTask;
  }

  private void ToggleProductoSeleccionado(int idProducto, object? isChecked)
  {
    if (isChecked is bool check)
    {
      if (check)
      {
        if (!modeloAgregar.IdsProductos.Contains(idProducto))
        {
          modeloAgregar.IdsProductos.Add(idProducto);
        }
      }
      else
      {
        modeloAgregar.IdsProductos.Remove(idProducto);
      }
    }
  }

  private async Task AgregarAsociacionesMultiples()
  {
    LimpiarMensajesModal();
    procesando = true;

    if (modeloAgregar.IdEntregable <= 0)
    {
      mensajeModal = "Debe seleccionar un entregable.";
      claseAvisoModal = "alert alert-warning";
      procesando = false;
      return;
    }

    if (modeloAgregar.IdsProductos.Count == 0)
    {
      mensajeModal = "Debe seleccionar al menos un producto.";
      claseAvisoModal = "alert alert-warning";
      procesando = false;
      return;
    }

    try
    {
      using var http = fabricaHttp.CreateClient("ApiProyecto");
      int exitosos = 0;
      int fallidos = 0;
      List<string> errores = new();

      foreach (var idProducto in modeloAgregar.IdsProductos)
      {
        var asociacion = new
        {
          IdProducto = idProducto,
          IdEntregable = modeloAgregar.IdEntregable,
          FechaAsociacion = modeloAgregar.FechaAsociacion ?? DateTime.Now
        };

        var respuesta = await http.PostAsJsonAsync(urlBaseApiAsociaciones, asociacion);

        if (respuesta.IsSuccessStatusCode)
        {
          exitosos++;
        }
        else
        {
          fallidos++;
          var detalle = await respuesta.Content.ReadAsStringAsync();
          errores.Add($"Producto {idProducto}: {detalle}");
        }
      }

      // Mensaje de resultado
      if (fallidos == 0)
      {
        mensajeModal = $"¡Éxito! Se asociaron {exitosos} producto(s) correctamente.";
        claseAvisoModal = "alert alert-success";

        // Recargar datos y cerrar modal después de 2 segundos
        await CargarAsociaciones();
        await Task.Delay(2000);
        CerrarModalAgregar();
      }
      else
      {
        mensajeModal = $"Resultados: {exitosos} exitoso(s), {fallidos} fallido(s). " +
        $"Errores: {string.Join("; ", errores)}";
        claseAvisoModal = "alert alert-warning";
        await CargarAsociaciones();
      }
    }
    catch (Exception error)
    {
      mensajeModal = $"Error al crear asociaciones: {error.Message}";
      claseAvisoModal = "alert alert-danger";
    }
    finally
    {
      procesando = false;
    }
  }

  // ==========================================
  // MODAL ELIMINAR - MÉTODOS
  // ==========================================

  private void AbrirModalEliminar()
  {
    modeloEliminar = new ModeloEliminarAsociaciones();
    productosAsociados.Clear();
    mostrarModalEliminar = true;
    LimpiarMensajesModal();
  }

  private void CerrarModalEliminar()
  {
    mostrarModalEliminar = false;
    modeloEliminar = new ModeloEliminarAsociaciones();
    productosAsociados.Clear();
    LimpiarMensajesModal();
  }

  private async Task CargarProductosAsociados(ChangeEventArgs e)
  {
    LimpiarMensajesModal();

    if (modeloEliminar.IdEntregable <= 0) return;

    try
    {
      // Filtrar asociaciones del entregable seleccionado
      productosAsociados = listaAsociaciones
      .Where(a => a.IdEntregable == modeloEliminar.IdEntregable)
      .ToList();

      if (productosAsociados.Count == 0)
      {
        mensajeModal = "Este entregable no tiene productos asociados.";
        claseAvisoModal = "alert alert-warning";
      }
      else
      {
        mensajeModal = $"Este entregable tiene {productosAsociados.Count} producto(s) asociado(s).";
        claseAvisoModal = "alert alert-info";
      }
    }
    catch (Exception error)
    {
      mensajeModal = $"Error al cargar productos asociados: {error.Message}";
      claseAvisoModal = "alert alert-danger";
    }

    await Task.CompletedTask;
  }

  private void ToggleProductoEliminar(int idProducto, object? isChecked)
  {
    if (isChecked is bool check)
    {
      if (check)
      {
        if (!modeloEliminar.IdsProductos.Contains(idProducto))
        {
          modeloEliminar.IdsProductos.Add(idProducto);
        }
      }
      else
      {
        modeloEliminar.IdsProductos.Remove(idProducto);
      }
    }
  }

  private async Task EliminarAsociacionesMultiples()
  {
    LimpiarMensajesModal();
    procesando = true;

    if (modeloEliminar.IdEntregable <= 0)
    {
      mensajeModal = "Debe seleccionar un entregable.";
      claseAvisoModal = "alert alert-warning";
      procesando = false;
      return;
    }

    if (modeloEliminar.IdsProductos.Count == 0)
    {
      mensajeModal = "Debe seleccionar al menos un producto para eliminar.";
      claseAvisoModal = "alert alert-warning";
      procesando = false;
      return;
    }

    try
    {
      using var http = fabricaHttp.CreateClient("ApiProyecto");
      int exitosos = 0;
      int fallidos = 0;
      List<string> errores = new();

      foreach (var idProducto in modeloEliminar.IdsProductos)
      {
        var url = $"{urlBaseApiAsociaciones}/producto/{idProducto}/entregable/{modeloEliminar.IdEntregable}";
        var respuesta = await http.DeleteAsync(url);

        if (respuesta.IsSuccessStatusCode)
        {
          exitosos++;
        }
        else
        {
          fallidos++;
          var detalle = await respuesta.Content.ReadAsStringAsync();
          errores.Add($"Producto {idProducto}: {detalle}");
        }
      } // Mensaje de resultado
      if (fallidos == 0)
      {
        mensajeModal = $"¡Éxito! Se eliminaron {exitosos} asociación(es) correctamente.";
        claseAvisoModal = "alert alert-success";

        // Recargar datos y cerrar modal después de 2 segundos
        await CargarAsociaciones();
        await Task.Delay(2000);
        CerrarModalEliminar();
      }
      else
      {
        mensajeModal = $"Resultados: {exitosos} exitoso(s), {fallidos} fallido(s). " +
        $"Errores: {string.Join("; ", errores)}";
        claseAvisoModal = "alert alert-warning";
        await CargarAsociaciones();
      }
    }
    catch (Exception error)
    {
      mensajeModal = $"Error al eliminar asociaciones: {error.Message}";
      claseAvisoModal = "alert alert-danger";
    }
    finally
    {
      procesando = false;
    }
  }

  // ==========================================
  // MÉTODOS AUXILIARES
  // ==========================================

  private void LimpiarMensajesGeneral()
  {
    mensajeGeneral = "";
    claseAvisoGeneral = "";
  }

  private void LimpiarMensajesModal()
  {
    mensajeModal = "";
    claseAvisoModal = "";
  }
}